{% extends 'base.html' %}
{% load static %}

{% block title %}Events - AnyVenue{% endblock %}

{% block content %}
<!-- Include Navbar -->
{% include 'navbar.html' %}

<!-- Main Content -->
<div class="w-full px-4 sm:px-8 lg:px-16 py-28 mt-16 bg-gradient-to-b from-Light-Navy to-Flash-White flex flex-col justify-start items-center gap-20">
    <div class="w-full max-w-7xl flex flex-col justify-start items-start gap-20">
        <div class="self-stretch flex flex-col lg:flex-row justify-between items-start lg:items-end gap-6">
            <div class="flex-1 max-w-[768px] flex flex-col justify-start items-start gap-4">
                <div class="self-stretch flex flex-col justify-start items-start gap-4">
                    <div class="self-stretch text-black text-4xl lg:text-5xl font-bold leading-tight lg:leading-[57.60px]">Events</div>
                    <div class="self-stretch text-black text-base lg:text-lg font-normal leading-relaxed">Discover and join exciting sports events in your area!</div>
                </div>
            </div>
            <div class="flex flex-col justify-start items-start gap-4">
                <button onclick="toggleCreateModal(true)" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-[#000457] transition-colors duration-300 font-medium">
                    Create New Event
                </button>
            </div>
        </div>

        <div class="self-stretch flex flex-col justify-start items-start gap-16">
            <!-- Events Container -->
            <div id="events-container" class="self-stretch grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Events will be loaded here via AJAX -->
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="w-full text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                <p class="mt-4 text-white">Loading events...</p>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden w-full text-center text-white py-12">
                <svg class="mx-auto h-24 w-24 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <p class="mt-4 text-xl">No events available</p>
                <p class="mt-2 text-white/70">Create your first event to get started!</p>
            </div>

            <!-- Pagination Controls -->
            <div id="pagination-controls" class="self-stretch flex flex-col sm:flex-row justify-between items-center gap-6">
                <div id="pagination-dots" class="flex justify-start items-start gap-2">
                    <!-- Dots will be generated dynamically -->
                </div>
                <div class="flex justify-start items-start gap-4">
                    <button id="prev-btn" class="p-3 bg-white rounded-full border border-gray-300 flex justify-center items-center gap-2 hover:bg-gray-50 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                    </button>
                    <button id="next-btn" class="p-3 bg-white rounded-full border border-gray-300 flex justify-center items-center gap-2 hover:bg-gray-50 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Footer -->
{% include 'footer.html' %}

<!-- Include Modals -->
{% include 'modal/create_event.html' %}
{% include 'modal/update_event.html' %}
{% include 'modal/delete_event.html' %}
{% endblock %}

{% block extra_js %}
<script>
    let allEvents = [];
    let currentPage = 0;
    const eventsPerPage = 6;

    // Load events on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadEvents();
        loadVenues();
    });

    // Load all events via AJAX
    async function loadEvents() {
        const container = document.getElementById('events-container');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        const paginationControls = document.getElementById('pagination-controls');

        try {
            const response = await fetch("{% url 'event:show_event_json' %}");
            allEvents = await response.json();
            
            loadingState.classList.add('hidden');
            
            if (allEvents.length === 0) {
                emptyState.classList.remove('hidden');
                paginationControls.classList.add('hidden');
            } else {
                displayEvents();
                setupPagination();
                paginationControls.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error loading events:', error);
            loadingState.classList.add('hidden');
            container.innerHTML = '<div class="col-span-full text-center text-red-500 py-12">Error loading events. Please try again later.</div>';
        }
    }

    // Display events for current page
    function displayEvents() {
        const container = document.getElementById('events-container');
        const start = currentPage * eventsPerPage;
        const end = start + eventsPerPage;
        const eventsToShow = allEvents.slice(start, end);

        container.innerHTML = eventsToShow.map(event => `
            <div class="bg-white border border-gray-200 rounded-lg flex flex-col justify-start items-start overflow-hidden shadow-sm hover:shadow-lg transition-shadow duration-300">
                <div class="self-stretch h-72 relative flex flex-col justify-start items-start">
                    <img class="self-stretch h-64 object-cover" src="${event.thumbnail || 'https://placehold.co/405x270'}" alt="${event.name}" loading="lazy">
                    <div class="absolute top-4 right-4">
                        <div class="px-3 py-1 bg-white rounded-full shadow-md">
                            <div class="text-gray-800 text-sm font-semibold">${event.venue_type}</div>
                        </div>
                    </div>
                </div>
                <div class="self-stretch p-6 flex flex-col justify-start items-start gap-4">
                    <div class="self-stretch flex flex-col justify-start items-start gap-4">
                        <div class="self-stretch flex flex-wrap justify-start items-center gap-4">
                            <div class="flex justify-start items-center gap-2">
                                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                </svg>
                                <div class="text-gray-700 text-sm font-normal">${formatDate(event.date)}</div>
                            </div>
                            <div class="flex justify-start items-center gap-2">
                                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                </svg>
                                <div class="text-gray-700 text-sm font-normal truncate">${event.venue_name}</div>
                            </div>
                        </div>
                        <div class="self-stretch flex flex-col justify-start items-start gap-2">
                            <div class="self-stretch text-gray-900 text-xl font-bold leading-relaxed">${event.name}</div>
                            <div class="self-stretch text-gray-600 text-sm font-normal leading-normal line-clamp-2">${event.description || 'No description available'}</div>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-sm font-semibold text-gray-900">Available:</span>
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">${event.available_slots}/${event.total_slots} slots</span>
                            </div>
                        </div>
                    </div>
                    <div class="self-stretch pt-2 flex justify-between items-center">
                        <a href="/event/${event.id}/" class="flex items-center gap-2 text-Orange hover:text-Sunrise-Orange transition-colors duration-300 font-medium">
                            <span>View event</span>
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </a>
                        <div class="flex gap-2">
                            <button onclick="openUpdateModal(${event.id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Edit">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            <button onclick="openDeleteModal(${event.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Setup pagination
    function setupPagination() {
        const totalPages = Math.ceil(allEvents.length / eventsPerPage);
        const dotsContainer = document.getElementById('pagination-dots');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        dotsContainer.innerHTML = Array.from({length: totalPages}, (_, i) => `
            <button 
                class="w-2 h-2 rounded-full transition-all duration-300 ${i === currentPage ? 'bg-white w-8' : 'bg-white opacity-40 hover:opacity-70'}" 
                onclick="goToPage(${i})"
                aria-label="Go to page ${i + 1}"
            ></button>
        `).join('');

        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage === totalPages - 1;

        prevBtn.onclick = () => {
            if (currentPage > 0) {
                currentPage--;
                displayEvents();
                setupPagination();
                scrollToTop();
            }
        };

        nextBtn.onclick = () => {
            if (currentPage < totalPages - 1) {
                currentPage++;
                displayEvents();
                setupPagination();
                scrollToTop();
            }
        };
    }

    function goToPage(page) {
        currentPage = page;
        displayEvents();
        setupPagination();
        scrollToTop();
    }

    function scrollToTop() {
        document.getElementById('events-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
        return date.toLocaleDateString('en-GB', options);
    }

    // Modal toggle functions
    function toggleCreateModal(show) {
        const modal = document.getElementById('createEventModal');
        modal.classList.toggle('hidden', !show);
        document.body.style.overflow = show ? 'hidden' : 'auto';
        if (!show) document.getElementById('createEventForm').reset();
    }

    function toggleUpdateModal(show) {
        const modal = document.getElementById('updateEventModal');
        modal.classList.toggle('hidden', !show);
        document.body.style.overflow = show ? 'hidden' : 'auto';
        if (!show) document.getElementById('updateEventForm').reset();
    }

    function toggleDeleteModal(show) {
        const modal = document.getElementById('deleteEventModal');
        modal.classList.toggle('hidden', !show);
        document.body.style.overflow = show ? 'hidden' : 'auto';
    }

    // Load venues for dropdown
    async function loadVenues() {
        try {
            const response = await fetch('/venue/json/');
            const venues = await response.json();
            
            const createSelect = document.querySelector('#createEventForm select[name="venue"]');
            const updateSelect = document.querySelector('#updateEventForm select[name="venue"]');
            
            const options = venues.length === 0 
                ? '<option value="">No venues available</option>'
                : '<option value="">Select a venue</option>' + venues.map(v => `<option value="${v.id}">${v.name} - ${v.type}</option>`).join('');
            
            createSelect.innerHTML = options;
            updateSelect.innerHTML = options;
        } catch (error) {
            console.error('Error loading venues:', error);
        }
    }

    // Open update modal with event data
    async function openUpdateModal(eventId) {
        try {
            const response = await fetch(`/event/json/${eventId}/`);
            const data = await response.json();
            const event = data[0];

            document.getElementById('updateEventId').value = event.id;
            document.getElementById('updateName').value = event.name;
            document.getElementById('updateVenue').value = event.venue;
            document.getElementById('updateDate').value = event.date;
            document.getElementById('updateStartTime').value = event.start_time;
            document.getElementById('updateTotalSlots').value = event.total_slots;
            document.getElementById('updateDescription').value = event.description || '';
            document.getElementById('updateThumbnail').value = event.thumbnail || '';

            toggleUpdateModal(true);
        } catch (error) {
            console.error('Error loading event:', error);
            showNotification('Error loading event data', 'error');
        }
    }

    // Open delete modal
    function openDeleteModal(eventId) {
        document.getElementById('deleteEventId').value = eventId;
        toggleDeleteModal(true);
    }

    // Handle create event form
    document.getElementById('createEventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        try {
            const response = await fetch("{% url 'event:create_event' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': document.querySelector('#createEventForm [name=csrfmiddlewaretoken]').value }
            });

            const data = await response.json();

            if (response.ok) {
                toggleCreateModal(false);
                loadEvents();
                showNotification('Event created successfully!', 'success');
            } else {
                showNotification('Error: ' + JSON.stringify(data.errors), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        }
    });

    // Handle update event form
    document.getElementById('updateEventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const eventId = document.getElementById('updateEventId').value;
        const formData = new FormData(this);
        
        try {
            const response = await fetch(`/event/update/${eventId}/`, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': document.querySelector('#updateEventForm [name=csrfmiddlewaretoken]').value }
            });

            const data = await response.json();

            if (response.ok) {
                toggleUpdateModal(false);
                loadEvents();
                showNotification('Event updated successfully!', 'success');
            } else {
                showNotification('Error: ' + JSON.stringify(data.errors), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        }
    });

    // Handle delete event form
    document.getElementById('deleteEventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const eventId = document.getElementById('deleteEventId').value;
        
        try {
            const response = await fetch(`/event/delete/${eventId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('#deleteEventForm [name=csrfmiddlewaretoken]').value }
            });

            const data = await response.json();

            if (response.ok) {
                toggleDeleteModal(false);
                loadEvents();
                showNotification('Event deleted successfully!', 'success');
            } else {
                showNotification('Error deleting event', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        }
    });

    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transition-all duration-300 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        } text-white`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Close modals on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            toggleCreateModal(false);
            toggleUpdateModal(false);
            toggleDeleteModal(false);
        }
    });
</script>
{% endblock %}