{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.name }} - AnyVenue{% endblock %}

{% block body_class %}{% endblock %}

{% block content %}
<!-- Include Navbar -->
{% include 'navbar.html' %}

<!-- Main Content -->
<div class="w-full px-4 sm:px-8 lg:px-16 py-28 bg-gradient-to-b from-Light-Navy to-Flash-White flex flex-col justify-start items-center gap-20">
    <div class="w-full max-w-7xl flex flex-col justify-start items-start gap-20">
        <!-- Event Header Section -->
        <div class="self-stretch flex flex-col lg:flex-row justify-start items-start gap-20">
            <!-- Left Column: Event Details -->
            <div class="flex-1 flex flex-col justify-start items-start gap-8">
                <!-- Breadcrumb -->
                <div class="self-stretch flex justify-start items-center gap-2">
                    <a href="{% url 'event:show_event' %}" class="text-center text-white text-base font-normal font-['Roboto'] leading-6 hover:underline">Events</a>
                    <div class="w-4 h-4 relative overflow-hidden">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </div>
                    <div id="event-breadcrumb" class="text-center text-white text-base font-normal font-['Roboto'] leading-6"></div>
                </div>

                <!-- Event Title and Description -->
                <div class="self-stretch flex flex-col justify-start items-start gap-6">
                    <div id="event-title" class="self-stretch text-white text-4xl lg:text-5xl font-bold font-['Roboto'] leading-tight lg:leading-[57.60px]" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.25);"></div>
                    <div id="event-description" class="self-stretch text-white text-lg font-normal font-['Roboto'] leading-7"></div>
                </div>

                <!-- Join Event Button -->
                <div id="join-button-container" class="flex justify-start items-start gap-4">
                    <button id="join-event-btn" onclick="showJoinModal()" class="px-6 py-3 rounded-lg bg-black border border-black flex justify-center items-center gap-2 hover:bg-[#000457] transition-colors duration-300">
                        <div class="text-black text-base font-normal font-['Roboto'] leading-6" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">Join Event</div>
                    </button>
                </div>
            </div>

            <!-- Right Column: Event Info -->
            <div class="w-full lg:w-[464px] flex flex-col justify-start items-start gap-8">
                <!-- Date & Venue -->
                <div class="self-stretch grid grid-cols-2 gap-8">
                    <div class="flex flex-col justify-start items-start gap-2">
                        <div class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">Date</div>
                        <div id="event-date" class="self-stretch text-white text-base font-normal font-['Roboto'] leading-6"></div>
                    </div>
                    <div class="flex flex-col justify-start items-start gap-2">
                        <div class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">Venue</div>
                        <div id="event-venue" class="self-stretch text-white text-base font-normal font-['Roboto'] leading-6"></div>
                    </div>
                </div>

                <!-- Location & Event Owner -->
                <div class="self-stretch grid grid-cols-2 gap-8">
                    <div class="flex flex-col justify-start items-start gap-2">
                        <div class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">Location</div>
                        <div id="event-location" class="self-stretch text-white text-base font-normal font-['Roboto'] leading-6 break-words"></div>
                    </div>
                    <div class="flex flex-col justify-start items-start gap-2">
                        <div class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">Event Owner</div>
                        <div id="event-owner" class="self-stretch text-white text-base font-normal font-['Roboto'] leading-6"></div>
                    </div>
                </div>

                <!-- Registered Participants & Sport Type -->
                <div class="self-stretch grid grid-cols-2 gap-8">
                    <div class="flex flex-col justify-start items-start gap-2">
                        <div class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">Registered Participants</div>
                        <div id="event-registered" class="self-stretch text-white text-base font-normal font-['Roboto'] leading-6"></div>
                    </div>
                    <div class="flex flex-col justify-start items-start gap-2">
                        <div class="self-stretch text-white text-xl font-bold font-['Roboto'] leading-7">Sport Type</div>
                        <div id="event-type" class="self-stretch text-white text-base font-normal font-['Roboto'] leading-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Image -->
        <img id="event-image" class="self-stretch h-[400px] lg:h-[738px] object-cover rounded-lg" src="https://placehold.co/1280x738" alt="Event Image">
    </div>
</div>

<!-- Include Footer -->
{% include 'footer.html' %}

<!-- Join Event Modal -->
{% include 'modal/join_event.html' %}
{% endblock %}

{% block extra_js %}
<script>
    const eventId = {{ event.id }};
    let eventData = null;
    let isRegistered = false;
    let isOwner = false;

    // Load event details on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadEventDetail();
        checkRegistrationStatus();
    });

    // Load event detail via AJAX
    async function loadEventDetail() {
        try {
            const response = await fetch(`/event/json/${eventId}/`);
            const data = await response.json();
            eventData = data[0];
            
            displayEventDetail(eventData);
        } catch (error) {
            console.error('Error loading event:', error);
            showNotification('Error loading event details', 'error');
        }
    }

    // Display event details
    function displayEventDetail(event) {
        document.getElementById('event-breadcrumb').textContent = event.name;
        document.getElementById('event-title').textContent = event.name;
        document.getElementById('event-description').textContent = event.description || 'No description available';
        document.getElementById('event-date').textContent = formatDate(event.date) + ' at ' + event.start_time;
        document.getElementById('event-venue').textContent = event.venue_name;
        document.getElementById('event-location').textContent = event.venue_address;
        document.getElementById('event-owner').textContent = event.owner;
        document.getElementById('event-type').textContent = event.venue_category;
        document.getElementById('event-registered').textContent = `${event.registered_count ?? 0} users registered`;
        if (event.thumbnail) {
            document.getElementById('event-image').src = event.thumbnail;
        }
    }

    // Check if user is already registered
    async function checkRegistrationStatus() {
        try {
            const response = await fetch(`/event/${eventId}/check-registration/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const data = await response.json();
            isRegistered = data.is_registered;
            isOwner = data.is_owner;
            
            updateJoinButton();
        } catch (error) {
            console.error('Error checking registration:', error);
        }
    }

    // Update join button based on registration status
    function updateJoinButton() {
        const btnContainer = document.getElementById('join-button-container');
        const btn = document.getElementById('join-event-btn');
        if (isOwner) {
            btnContainer.classList.add('hidden');
            return;
        }
        if (isRegistered) {
            btn.innerHTML = '<div class="text-white text-base font-normal font-[\'Roboto\'] leading-6">Already Registered</div>';
            btn.disabled = true;
            btn.onclick = null;
            btn.classList.remove('hover:bg-[#000457]', 'bg-black', 'border-black');
            btn.classList.add('opacity-70', 'cursor-not-allowed', 'bg-gray-500', 'border-gray-500');
        } else {
            btn.innerHTML = '<div class="text-white text-base font-normal font-[\'Roboto\'] leading-6">Join Event</div>';
            btn.disabled = false;
            btn.onclick = showJoinModal;
            btn.classList.add('hover:bg-[#000457]', 'bg-black', 'border-black');
            btn.classList.remove('opacity-70', 'cursor-not-allowed', 'bg-gray-500', 'border-gray-500');
        }
    }

    function showJoinModal() {
        if (isRegistered || isOwner) return;
        
        toggleJoinModal(true);
    }

    function toggleJoinModal(show) {
        const modal = document.getElementById('joinEventModal');
        modal.classList.toggle('hidden', !show);
        document.body.style.overflow = show ? 'hidden' : 'auto';
    }

    // Handle join event confirmation
    document.getElementById('joinEventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Joining...';
        
        try {
            const response = await fetch(`/event/${eventId}/join/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (response.ok) {
                toggleJoinModal(false);
                isRegistered = true;
                updateJoinButton();
                
                await loadEventDetail();
                
                showNotification('Successfully joined the event!', 'success');
            } else {
                showNotification(data.message || 'Error joining event', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
        return date.toLocaleDateString('en-GB', options);
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transition-all duration-300 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        } text-white`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            toggleJoinModal(false);
        }
    });
</script>
{% endblock %}