{% extends "base.html" %}
{% load static %}

{% block title %}AnyVenue – Profile{% endblock %}

{% block content %}
{% include 'navbar.html' %}

<div class="min-h-screen w-full px-8 md:px-16 py-28 flex flex-col items-center bg-gradient-to-b from-Light-Navy  to-Flash-White">
    <div class="w-full max-w-[1100px] flex flex-col gap-10">

        <!-- Header -->
        <div class="text-center">
            <h1 class="text-4xl font-bold text-Flash-White">Profile</h1>
            {% if profile %}
                <p class="text-Flash-White text-600 mt-2">Welcome back, {{ profile.user.username }}</p>
            {% else %}
                <p class="text-Flash-White mt-2">Guest Profile (Please login)</p>
            {% endif %}
        </div>

        {% if profile %}
        <!-- Profile Info -->
        <div class="flex justify-between items-center gap-4">
            <div class="flex flex-col gap-2">
                <div class="text-2xl font-bold text-Flash-White">{{ profile.user.username }}</div>
                <div class="text-Flash-White font-semibold">Role: {{ profile.get_role_display }}</div>
                <div class="text-Flash-White">Last Login: {{ profile.last_login|date:"d M Y, H:i" }}</div>
            </div>
            <div class="flex gap-4">
                <a href="#" class="px-6 py-3 outline outline-1 outline-Flash-White text-Flash-White font-semibold hover:bg-Flash-White hover:text-Dark-Slate transition">Edit Profile</a>
                    <!-- Modal Edit Profile -->
                    <div id="editProfileModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
                        <div class="bg-white rounded-2xl w-[400px] p-6 shadow-xl">
                            <h2 class="text-2xl font-bold text-Dark-Navy mb-4">Edit Profile</h2>
                            <form id="editProfileForm" class="flex flex-col gap-4">
                                <div>
                                    <label class="text-gray-700 font-semibold text-sm">Username</label>
                                    <input id="edit-username" type="text" class="w-full mt-1 px-3 py-2 border rounded-xl focus:ring-2 focus:ring-Light-Navy" value="{{ profile.user.username }}">
                                </div>

                                <div>
                                    <label class="text-gray-700 font-semibold text-sm">Role</label>
                                    <select id="edit-role" class="w-full mt-1 px-3 py-2 border rounded-xl focus:ring-2 focus:ring-Light-Navy">
                                        <option value="USER" {% if profile.role == 'USER' %}selected{% endif %}>User</option>
                                        <option value="OWNER" {% if profile.role == 'OWNER' %}selected{% endif %}>Owner</option>
                                    </select>
                                </div>

                                <div class="flex justify-end gap-3 mt-6">
                                    <button type="button" id="cancelEdit" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 bg-Dark-Navy text-white rounded-xl hover:bg-Light-Navy">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>

                <a href="#" class="px-6 py-3 bg-black text-Flash-White font-semibold hover:bg-Dark-Slate transition">Hapus Akun</a>
            </div>
        </div>
        {% endif %}

        {% if profile and profile.is_owner %}
        <!-- OWNER VIEW -->
        <div>
            <div class="mt-8 flex gap-4 mb-4 justify-between items-center">
                <button class="tab-btn px-4 py-2 text-Flash-White outline outline-1 outline-Flash-White font-semibold">My Venues</button>
                <div id="owner-filter" class="flex justify-end">
                    <button id="refresh-owner" class="flex-shrink-0 group inline-flex items-center justify-center p-3.5 h-[50px] w-[50px] bg-white text-gray-800 border rounded-full border-gray-300 transition-all duration-300 hover:bg-gray-100 hover:shadow-md">
                    <svg class="w-5 h-5 text-Dark-Slate transition-transform duration-700 group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8M21 3v5h-5"></path></svg></button>
                </div>
            </div>

            

            <div id="loading" class="text-center py-8">
                <p class="animate-pulse text-gray-500">Loading venues...</p>
            </div>
            
            <div id="empty" class="text-center py-8 hidden">
                <p class="text-gray-500">No venues available.</p>
            </div>

            <!-- Grid kosong dulu, akan diisi oleh JavaScript -->
            <div id="venue-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        {% elif profile %}
        <!-- USER VIEW -->
        <div>
            <!-- Tabs -->
            <div class="flex justify-center gap-4 mb-4">
                <button id="tab-booking" class="tab-btn bg-Dark-Navy text-white px-4 py-2 rounded-xl font-semibold">My Bookings</button>
                <button id="tab-review" class="tab-btn bg-white text-Dark-Navy border border-Dark-Navy px-4 py-2 rounded-xl font-semibold">My Reviews</button>
            </div>

            <!-- Filter -->
            <div id="filter-section" class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-2">
                    <label for="filter-sort" class="text-gray-600 font-semibold">Sort By:</label>
                    <select id="filter-sort" class="border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-Light-Navy">
                        <option value="asc">Ascending</option>
                        <option value="desc" selected>Descending</option>
                    </select>
                </div>
                <button id="refresh-btn" class="flex-shrink-0 group inline-flex items-center justify-center p-3.5 h-[50px] w-[50px] bg-white text-gray-800 border rounded-full border-gray-300 transition-all duration-300 hover:bg-gray-100 hover:shadow-md">
                <svg class="w-5 h-5 text-Dark-Slate transition-transform duration-700 group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8M21 3v5h-5"></path></svg></button>
            </div>

            <!-- Card Grid -->
            <div id="card-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mt-6"></div>
        </div>

        {% else %}
        <!-- GUEST VIEW -->
        <p class="text-center text-gray-500 mt-10">Please login to see your profile.</p>
        {% endif %}
    </div>
</div>

{% include 'footer.html' %}
{% endblock content %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
// Global variables
let bookings = [];
let reviews = [];
let venues = [];
let currentTab = "booking";

async function loadData() {
    const isOwner = "{{ profile.is_owner|yesno:'true,false' }}" === "true";
    
    if (isOwner) {
        const loading = document.getElementById("loading");
        const empty = document.getElementById("empty");
        const venueGrid = document.getElementById("venue-grid");
        
        loading.classList.remove("hidden");
        empty.classList.add("hidden");
        venueGrid.innerHTML = ""; // Clear grid
        
        try {
            const res = await fetch("/account/api/venues/");
            
            if (!res.ok) {
                console.error("API Venue error:", res.status, res.statusText);
                loading.classList.add("hidden");
                empty.classList.remove("hidden");
                return;
            }
            
            venues = await res.json();
            console.log(" Venues loaded:", venues.length, venues);
            
            loading.classList.add("hidden");
            renderOwnerVenues(venues);
            
        } catch (error) {
            console.error(" Error loading venues:", error);
            loading.classList.add("hidden");
            empty.classList.remove("hidden");
        }
        return;
    }

    // For regular users - load bookings and reviews
    try {
        const [bookRes, revRes] = await Promise.all([
            fetch("/account/api/bookings/"),
            fetch("/account/api/reviews/"),
        ]);
        
        bookings = Array.isArray(await bookRes.json()) ? await bookRes.json() : [];
        reviews = Array.isArray(await revRes.json()) ? await revRes.json() : [];

        
        console.log("Bookings loaded:", bookings.length);
        console.log(" Reviews loaded:", reviews.length);
        
        renderCards();
    } catch (error) {
        console.error("Error loading data:", error);
    }
}

function renderOwnerVenues(venuesData) {
    const venueGrid = document.getElementById("venue-grid");
    const empty = document.getElementById("empty");

    venueGrid.innerHTML = "";

    if (!venuesData || venuesData.length === 0) {
        console.log("No venues to display");
        empty.classList.remove("hidden");
        return;
    }

    empty.classList.add("hidden");
    
    console.log(" Rendering", venuesData.length, "venues");

    const venueHTML = venuesData.map((v) => {
        const priceFormatted = v.price ? `Rp ${Number(v.price).toLocaleString("id-ID")}` : '-';
        const descriptionShort = (v.description && v.description.length > 100) 
            ? v.description.substring(0, 100) + '...' 
            : (v.description || 'No description available.');
        
        return `
        <article class="group bg-white border border-Dark-Slate hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden flex flex-col card-animate">
            <a href="#" class="block aspect-[16/9] relative overflow-hidden">
                <img src="${v.image_url || '{% static "image/placeholder.png" %}'}" alt="${v.name}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                <div class="absolute top-3 left-3 flex gap-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 border border-Dark-Slate">${v.category || "Uncategorized"}</span>
                </div>
            </a>
            <div class="p-6 flex flex-col flex-1 gap-6">
                <div class="flex flex-col gap-2">
                    <h3 class="text-xl font-bold text-Dark-Navy">${v.name || 'Unnamed Venue'}</h3>
                    <p class="text-gray-700 text-base line-clamp-3">${descriptionShort}</p>
                </div>
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex items-center gap-2 text-gray-700 text-sm">
                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        ${v.city || "Unknown City"}
                    </div>
                    <div class="flex items-center gap-2 text-gray-700 text-sm">
                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                        </svg>
                        ${v.category || "Type"}
                    </div>
                </div>
                <div class="flex justify-between items-end mt-auto">
                    <span class="text-gray-900 text-2xl font-bold">${priceFormatted}</span>
                    <a href="#" class="px-5 py-2 bg-black text-white text-base font-normal hover:bg-Dark-Slate transition-colors">View More</a>
                </div>
            </div>
        </article>
        `;
    }).join("");

    venueGrid.innerHTML = venueHTML;

    requestAnimationFrame(() => {
        gsap.from(".card-animate", {
            opacity: 0, 
            y: 30, 
            duration: 0.1, 
            stagger: 0.08, 
            ease: "power2.out",
            clearProps: "all"
        });
    });
}


function renderCards() {
    const cardGrid = document.getElementById("card-grid");
    const filterSort = document.getElementById("filter-sort");
    
    cardGrid.innerHTML = "";
    let dataToDisplay = currentTab === "booking" ? [...bookings] : [...reviews];

    if (currentTab === "booking") {
        dataToDisplay.sort((a, b) => {
            const diff = new Date(a.date) - new Date(b.date);
            return filterSort.value === "asc" ? diff : -diff;
        });
    } else {
        dataToDisplay.sort((a, b) => {
            return filterSort.value === "asc" ? a.rating - b.rating : b.rating - a.rating;
        });
    }

    if (!dataToDisplay.length) {
        cardGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full">No ${currentTab}s found.</p>`;
        return;
    }

    const cardsHTML = dataToDisplay.map(item => {
        if (currentTab === "booking") {
            return `
            <div class="card bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                <h3 class="text-xl font-semibold text-Dark-Navy">${item.venue_name}</h3>
                <p class="text-gray-500 mt-1">Date: ${item.date}</p>
                <p class="text-gray-600 mt-1 font-medium">Status: ${item.status}</p>
            </div>`;
        } else {
            return `
            <div class="card bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                <h3 class="text-xl font-semibold text-Dark-Navy">${item.venue_name}</h3>
                <p class="text-yellow-500 mt-2">${"⭐".repeat(item.rating)}</p>
                <p class="text-gray-600 mt-1 italic">"${item.comment}"</p>
            </div>`;
        }
    }).join("");

    cardGrid.innerHTML = cardsHTML;
    gsap.from(".card", {
        opacity: 0, y: 30, duration: 0.4, stagger: 0.1, ease: "power2.out"
    });
}

document.addEventListener("DOMContentLoaded", () => {
    const isOwner = "{{ profile.is_owner|yesno:'true,false' }}" === "true";

    console.log("Page loaded. Is owner?", isOwner);

    // Load data immediately
    loadData();

    if (isOwner) {
        const refreshBtn = document.getElementById("refresh-owner");
        if (refreshBtn) {
            refreshBtn.addEventListener("click", () => {
                console.log(" Refreshing venues...");
                loadData();
            });
        }
    } else {
        // Setup event listeners for user view
        const tabBooking = document.getElementById("tab-booking");
        const tabReview = document.getElementById("tab-review");
        const filterSort = document.getElementById("filter-sort");
        const refreshBtn = document.getElementById("refresh-btn");

        tabBooking.addEventListener("click", () => {
            currentTab = "booking";
            tabBooking.classList.add("bg-Dark-Navy", "text-white");
            tabBooking.classList.remove("bg-white", "text-Dark-Navy", "border");
            tabReview.classList.remove("bg-Dark-Navy", "text-white");
            tabReview.classList.add("bg-white", "text-Dark-Navy", "border");
            filterSort.innerHTML = `
                <option value="asc">Date Ascending</option>
                <option value="desc" selected>Date Descending</option>
            `;
            renderCards();
        });

        tabReview.addEventListener("click", () => {
            currentTab = "review";
            tabReview.classList.add("bg-Dark-Navy", "text-white");
            tabReview.classList.remove("bg-white", "text-Dark-Navy", "border");
            tabBooking.classList.remove("bg-Dark-Navy", "text-white");
            tabBooking.classList.add("bg-white", "text-Dark-Navy", "border");
            filterSort.innerHTML = `
                <option value="asc">Lowest Rating</option>
                <option value="desc" selected>Highest Rating</option>
            `;
            renderCards();
        });

        refreshBtn.addEventListener("click", () => {
            console.log("Refreshing data...");
            loadData();
        });

        filterSort.addEventListener("change", renderCards);
    }
});
document.addEventListener("DOMContentLoaded", () => {
    const editBtn = document.querySelector('a[href="#"]'); // Tombol Edit Profile
    const modal = document.getElementById("editProfileModal");
    const cancelBtn = document.getElementById("cancelEdit");
    const form = document.getElementById("editProfileForm");

    // Buka modal
    editBtn.addEventListener("click", (e) => {
        e.preventDefault();
        modal.classList.remove("hidden");
        modal.classList.add("flex");
    });

    // Tutup modal
    cancelBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
    });

    // Submit form edit profile
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
            username: document.getElementById("edit-username").value,
            role: document.getElementById("edit-role").value,
        };

        try {
            const res = await fetch("/account/api/edit-profile/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify(payload),
            });

            const data = await res.json();

            if (data.success) {
                alert("Profile updated successfully!");
                modal.classList.add("hidden");
                location.reload(); // reload biar langsung update nama & role di UI
            } else {
                alert("Error: " + (data.error || "Failed to update"));
            }
        } catch (err) {
            console.error("Edit profile error:", err);
            alert("Unexpected error occurred.");
        }
    });
});

// Helper ambil CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock extra_js %}