{% extends 'base.html' %}
{% load static %}

{% block title %}Detail Booking #{{ booking.id }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Detail Booking #{{ booking.id }}</h1>
        
        {% if messages %}
            {% for message in messages %}
            <div class="mb-4 p-4 rounded {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}

        <div class="bg-white shadow rounded-lg p-6">
            <!-- Status Badge -->
            <div class="mb-6">
                <span class="px-4 py-2 rounded text-lg font-semibold
                    {% if booking.status == 'pending' %}bg-yellow-100 text-yellow-800
                    {% elif booking.status == 'confirmed' %}bg-blue-100 text-blue-800
                    {% elif booking.status == 'completed' %}bg-green-100 text-green-800
                    {% else %}bg-red-100 text-red-800{% endif %}">
                    Status: {{ booking.get_status_display }}
                </span>
            </div>

            <!-- Booking Info -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="text-xl font-semibold mb-4">Informasi Venue</h3>
                    <dl class="space-y-2">
                        <div>
                            <dt class="font-medium text-gray-600">Nama Venue:</dt>
                            <dd class="text-lg">{{ booking.venue.name }}</dd>
                        </div>
                        <div>
                            <dt class="font-medium text-gray-600">Alamat:</dt>
                            <dd>{{ booking.venue.address }}</dd>
                        </div>
                        <div>
                            <dt class="font-medium text-gray-600">Tipe:</dt>
                            <dd>{{ booking.get_date_type_display }}</dd>
                        </div>
                    </dl>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4">Detail Booking</h3>
                    <dl class="space-y-2">
                        <div>
                            <dt class="font-medium text-gray-600">Tanggal Booking:</dt>
                            <dd class="text-lg">{{ booking.booking_date|date:"d F Y" }}</dd>
                        </div>
                        <div>
                            <dt class="font-medium text-gray-600">Pemesan:</dt>
                            <dd>{{ booking.user.username }}</dd>
                        </div>
                        <div>
                            <dt class="font-medium text-gray-600">Dibuat pada:</dt>
                            <dd>{{ booking.created_at|date:"d F Y, H:i" }}</dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Price Details -->
            <div class="border-t pt-6 mb-6">
                <h3 class="text-xl font-semibold mb-4">Rincian Harga</h3>
                <dl class="space-y-2">
                    <div class="flex justify-between">
                        <dt class="text-gray-600">Harga per unit:</dt>
                        <dd>Rp {{ booking.price|floatformat:0 }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-600">Quantity:</dt>
                        <dd>{{ booking.quantity }}</dd>
                    </div>
                    <div class="flex justify-between text-xl font-bold border-t pt-2">
                        <dt>Total:</dt>
                        <dd>Rp {{ booking.total_price|floatformat:0 }}</dd>
                    </div>
                </dl>
            </div>

            <!-- Actions -->
            <div class="border-t pt-6 flex gap-4">
                {% if booking.user == request.user %}
                    <!-- User Actions -->
                    {% if booking.is_cancellable %}
                    <button onclick="cancelBooking()" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Cancel Booking
                    </button>
                    {% endif %}
                    
                    {% if booking.is_reviewable %}
                    <a href="{% url 'review:create' booking.id %}" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        Add Review
                    </a>
                    {% endif %}
                {% endif %}

                {% if booking.venue.owner == request.user %}
                    <!-- Owner Actions -->
                    {% if booking.status == 'pending' %}
                    <button onclick="confirmBooking()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Confirm Booking
                    </button>
                    {% endif %}
                    
                    {% if booking.status == 'confirmed' %}
                    <button onclick="completeBooking()" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        Complete Booking
                    </button>
                    {% endif %}
                {% endif %}

                <a href="{% url 'booking:my_bookings' %}" class="px-6 py-2 border border-gray-300 rounded hover:bg-gray-50">
                    Kembali
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function cancelBooking() {
    if (confirm('Apakah Anda yakin ingin membatalkan booking ini?')) {
        fetch('{% url "booking:cancel" booking.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Terjadi kesalahan. Silakan coba lagi.');
        });
    }
}

function confirmBooking() {
    if (confirm('Konfirmasi booking ini?')) {
        fetch('{% url "booking:confirm" booking.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Terjadi kesalahan. Silakan coba lagi.');
        });
    }
}

function completeBooking() {
    if (confirm('Tandai booking ini sebagai selesai?')) {
        fetch('{% url "booking:complete" booking.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Terjadi kesalahan. Silakan coba lagi.');
        });
    }
}
</script>
{% endblock %}
