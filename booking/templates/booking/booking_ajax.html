{% extends 'base.html' %}
{% load static %}

{% block body_class %}{% endblock %}

{% block content %}

{% include 'navbar.html' %}

<div class="w-full pt-24 pb-16 bg-gradient-to-b from-Light-Navy to-Flash-White flex flex-col items-center">
  <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col items-start gap-6">
    <nav aria-label="Breadcrumb" class="flex items-center gap-2 text-sm text-Flash-White opacity-0 animate-[fadeIn_0.6s_ease-out_forwards]">
      <a href="{% url 'venue:venue_main' %}" class="hover:underline font-normal leading-tight">All Venues</a>
      <svg class="w-4 h-4 shrink-0" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M6 12.5L10 8.5L6 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="font-semibold leading-tight">{{ venue.name }}</span>
    </nav>

    
  </div>
</div>

<div class="bg-Flash-White min-h-screen pb-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    {% if not user.is_authenticated %}
    <!-- Login Required Notice -->
    <div class="bg-red-50 border border-red-200 p-5 mb-6 rounded">
      <div class="flex items-start gap-4">
        <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
        </svg>
        <div class="flex-1">
          <h3 class="text-base font-semibold text-[#000456] mb-1">Login Diperlukan</h3>
          <p class="text-sm text-gray-700 mb-3">Anda harus login terlebih dahulu untuk melakukan booking lapangan.</p>
          <a href="/auth/login?next={{ request.path }}" class="inline-block px-5 py-2 bg-gray-900 text-white text-sm rounded hover:bg-gray-800 transition font-medium">
            Login Sekarang
          </a>
        </div>
      </div>
    </div>
    {% endif %}
    

    <!-- Product price -->
    <div class="mb-6">
  <h2 class="text-4xl sm:text-5xl font-bold text-[#000456] leading-tight mb-6">{{ venue.name }}</h2>
      <div class="text-2xl font-bold text-[#000456]"><span id="venuePrice" data-price="{{ venue.price|floatformat:0 }}">Rp0</span> <span class="text-base font-normal text-gray-500">/ per sesi</span></div>
    </div>

    <!-- Details Section -->
    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
        <h3 class="text-xl font-bold text-gray-900 mb-3">Venue Details</h3>
        <p class="text-base text-gray-700 leading-relaxed">
        Type: <span class="font-medium">{{ venue.type|title }}</span><br>
        Lokasi: {{ venue.address }}
      </p>
    </div>

    <!-- Booking Card -->
    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-8 relative">
      <!-- Week day selector -->
      <div class="flex gap-2 mb-4 overflow-x-auto pb-2 items-center">
        <button class="day-btn flex-shrink-0 bg-gray-900 text-white px-5 py-2.5 rounded font-medium hover:bg-gray-800 transition text-sm" data-offset="0">
        <div class="text-xs opacity-80" id="day-name-0"></div>
        <div class="text-base font-bold" id="day-0"></div>
      </button>
      <button class="day-btn flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded font-medium hover:border-gray-400 transition text-sm" data-offset="1">
        <div class="text-xs opacity-70" id="day-name-1"></div>
        <div class="text-base font-bold" id="day-1"></div>
      </button>
      <button class="day-btn flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded font-medium hover:border-gray-400 transition text-sm" data-offset="2">
        <div class="text-xs opacity-70" id="day-name-2"></div>
        <div class="text-base font-bold" id="day-2"></div>
      </button>
      <button class="day-btn flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded font-medium hover:border-gray-400 transition text-sm" data-offset="3">
        <div class="text-xs opacity-70" id="day-name-3"></div>
        <div class="text-base font-bold" id="day-3"></div>
      </button>
      <button class="day-btn flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded font-medium hover:border-gray-400 transition text-sm" data-offset="4">
        <div class="text-xs opacity-70" id="day-name-4"></div>
        <div class="text-base font-bold" id="day-4"></div>
      </button>
      <button class="day-btn flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded font-medium hover:border-gray-400 transition text-sm" data-offset="5">
        <div class="text-xs opacity-70" id="day-name-5"></div>
        <div class="text-base font-bold" id="day-5"></div>
      </button>
      <button class="day-btn flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded font-medium hover:border-gray-400 transition text-sm" data-offset="6">
        <div class="text-xs opacity-70" id="day-name-6"></div>
        <div class="text-base font-bold" id="day-6"></div>
      </button>
        <button class="calendar-btn flex-shrink-0 bg-white border border-gray-300 text-gray-700 px-5 py-2.5 h-14 rounded hover:border-gray-400 transition flex items-center justify-center" aria-haspopup="dialog" aria-expanded="false">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
      </button>

        <!-- Calendar popover -->
        <div id="calendarPopover" class="hidden absolute z-20 top-16 right-4 bg-white border border-gray-200 rounded-lg shadow-xl w-[680px] max-w-[90vw] p-4">
          <div class="flex items-center justify-between mb-3">
            <button id="calPrev" class="p-2 rounded hover:bg-gray-100" aria-label="Previous month">
              <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
            </button>
            <div id="calTitle" class="text-lg font-semibold">Okt 2025</div>
            <button id="calNext" class="p-2 rounded hover:bg-gray-100" aria-label="Next month">
              <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 4.293a1 1 0 011.414 0l5 5a1 1 0 010 1.414l-5 5a1 1 0 11-1.414-1.414L11.586 10 7.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
            </button>
          </div>
          <div class="grid grid-cols-7 gap-2 text-center text-xs text-gray-500 mb-2">
            <div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div><div>Min</div>
          </div>
          <div id="calGrid" class="grid grid-cols-7 gap-2"></div>
        </div>
      </div>

      <!-- Time slots grid -->
      <div id="slotContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6">
        <!-- Slots will be loaded here dynamically -->
      </div>

      <!-- Action bar -->
      <div class="flex items-center justify-between pt-4 border-t border-gray-200">
        <div>
          <p class="text-sm text-gray-600 mb-1">Total</p>
          <p class="text-3xl font-bold text-gray-900" id="totalPrice">Rp0</p>
        </div>
        <button id="bookButton"
                class="bg-gray-900 text-white px-10 py-3 rounded-md font-semibold hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition text-sm"
                {% if not user.is_authenticated %}disabled title="Login diperlukan untuk booking"{% else %}disabled{% endif %}>
          {% if user.is_authenticated %}Book Now{% else %}Login untuk Booking{% endif %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 space-y-2 w-full max-w-md px-4"></div>

<!-- Custom Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 animate-fade-in">
    <h3 class="text-xl font-bold text-[#000456] mb-3">Batalkan Booking</h3>
    <p class="text-gray-700 mb-6" id="confirmMessage">Apakah Anda yakin ingin membatalkan booking untuk slot ini?</p>
    <div class="flex gap-3 justify-end">
      <button id="cancelBtn" class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:border-gray-400 transition font-medium">
        Tidak
      </button>
      <button id="confirmBtn" class="px-6 py-2.5 bg-red-600 text-white rounded-lg hover:opacity-90 transition font-medium">
        Ya, Batalkan
      </button>
    </div>
  </div>
</div>

<!-- Removed hidden date input: replaced by custom calendar popover -->

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
.animate-fade-in {
  animation: fadeIn 0.2s ease-out;
}
</style>

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
const slotContainer = document.getElementById('slotContainer');
const totalPriceEl = document.getElementById('totalPrice');
const bookButton = document.getElementById('bookButton');
const confirmModal = document.getElementById('confirmModal');
const confirmBtn = document.getElementById('confirmBtn');
const cancelBtn = document.getElementById('cancelBtn');
const confirmMessage = document.getElementById('confirmMessage');
const venuePriceEl = document.getElementById('venuePrice');
const dayNamesShort = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];
// Calendar popover refs
const calendarBtn = document.querySelector('.calendar-btn');
const calendarPopover = document.getElementById('calendarPopover');
const calTitle = document.getElementById('calTitle');
const calGrid = document.getElementById('calGrid');
const calPrev = document.getElementById('calPrev');
const calNext = document.getElementById('calNext');
let selectedSlots = [];
let currentDate = new Date();
// Week base date controls the 7 day header (day-0..day-6)
let weekBaseDate = new Date();
// Month being displayed in the popover
let calendarMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
let pendingCancelId = null;

// Update the 7-day header from a base date
function updateWeek(baseDate) {
  weekBaseDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
  for (let i = 0; i < 7; i++) {
    const date = new Date(weekBaseDate);
    date.setDate(weekBaseDate.getDate() + i);

    const dayEl = document.getElementById(`day-${i}`);
    if (dayEl) {
      dayEl.textContent = `${date.getDate()} ${monthNames[date.getMonth()]}`;
    }

    const dayNameEl = document.getElementById(`day-name-${i}`);
    if (dayNameEl) {
      const dayOfWeek = date.getDay();
      dayNameEl.textContent = dayNamesShort[dayOfWeek];
    }
  }
}

// Initialize dates
function initializeDates() {
  // Format top price like total (Rp350.000)
  if (venuePriceEl) {
    const raw = parseInt(venuePriceEl.dataset.price || '0', 10);
    venuePriceEl.textContent = `Rp${raw.toLocaleString('id-ID')}`;
  }
  updateWeek(new Date());
  // Set first button active by default
  document.querySelectorAll('.day-btn').forEach((b, idx) => {
    b.classList.remove('bg-gray-900', 'text-white');
    b.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
    if (idx === 0) {
      b.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
      b.classList.add('bg-gray-900', 'text-white');
    }
  });
  currentDate = new Date(weekBaseDate);
  loadSlots(currentDate);
}

// Format date to YYYY-MM-DD
function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Day button click handlers
document.querySelectorAll('.day-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    // Remove active class from all buttons
    document.querySelectorAll('.day-btn').forEach(b => {
        b.classList.remove('bg-gray-900', 'text-white');
      b.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
    });
    // Add active class to clicked button
      this.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
      this.classList.add('bg-gray-900', 'text-white');

    const offset = parseInt(this.dataset.offset);
    const base = new Date(weekBaseDate);
    currentDate = new Date(base);
    currentDate.setDate(base.getDate() + offset);
    loadSlots(currentDate);
  });
});

// Calendar popover helpers
function formatMonthYear(date) {
  return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
}

function isSameDate(a, b) {
  return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
}

function renderCalendar() {
  // Ensure calendarMonthDate is first of month
  calendarMonthDate = new Date(calendarMonthDate.getFullYear(), calendarMonthDate.getMonth(), 1);
  calTitle.textContent = formatMonthYear(calendarMonthDate);
  calGrid.innerHTML = '';

  // Monday-first calendar: compute the index of first day
  const firstDay = new Date(calendarMonthDate);
  const startDayIdx = (firstDay.getDay() + 6) % 7; // 0=Mon ... 6=Sun

  // Determine days in month
  const daysInMonth = new Date(calendarMonthDate.getFullYear(), calendarMonthDate.getMonth() + 1, 0).getDate();

  // Previous month padding
  for (let i = 0; i < startDayIdx; i++) {
    const cell = document.createElement('div');
    cell.className = 'text-center py-2 text-sm text-gray-300 select-none';
    cell.textContent = '';
    calGrid.appendChild(cell);
  }

  const today = new Date();
  // Days of current month
  for (let d = 1; d <= daysInMonth; d++) {
    const dateObj = new Date(calendarMonthDate.getFullYear(), calendarMonthDate.getMonth(), d);
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'w-full py-2.5 rounded text-sm border border-transparent hover:border-gray-300 hover:bg-gray-50 transition';
    btn.textContent = d;

    const isPast = dateObj < new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const isSelected = isSameDate(dateObj, currentDate);
    const isToday = isSameDate(dateObj, today);

    if (isPast) {
      btn.classList.add('text-gray-300', 'cursor-not-allowed');
      btn.disabled = true;
    } else {
      // Selected date: match day-button selected style (dark bg + white text)
      if (isSelected) {
        btn.classList.add('bg-gray-900', 'text-white');
      } else {
        btn.classList.add('text-gray-800');
        if (isToday) btn.classList.add('border-gray-300');
      }

      btn.addEventListener('click', () => {
        // Select this date
        currentDate = new Date(dateObj);
        updateWeek(currentDate);
        // Mark first day button active
        document.querySelectorAll('.day-btn').forEach((b, idx) => {
          b.classList.remove('bg-gray-900', 'text-white');
          b.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
          if (idx === 0) {
            b.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
            b.classList.add('bg-gray-900', 'text-white');
          }
        });
        // Re-render calendar to update selected style
        renderCalendar();
        calendarPopover.classList.add('hidden');
        loadSlots(currentDate);
      });
    }

    calGrid.appendChild(btn);
  }
}

// Calendar button handler: toggle popover and render
calendarBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  const isHidden = calendarPopover.classList.contains('hidden');
  if (isHidden) {
    // Open popover at currentDate's month
    calendarMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    renderCalendar();
    calendarPopover.classList.remove('hidden');
    calendarBtn.setAttribute('aria-expanded', 'true');
  } else {
    calendarPopover.classList.add('hidden');
    calendarBtn.setAttribute('aria-expanded', 'false');
  }
});

// Outside click closes popover
document.addEventListener('click', (e) => {
  if (!calendarPopover.classList.contains('hidden')) {
    if (!calendarPopover.contains(e.target) && !calendarBtn.contains(e.target)) {
      calendarPopover.classList.add('hidden');
      calendarBtn.setAttribute('aria-expanded', 'false');
    }
  }
});

// Month navigation
calPrev.addEventListener('click', (e) => {
  e.stopPropagation();
  calendarMonthDate = new Date(calendarMonthDate.getFullYear(), calendarMonthDate.getMonth() - 1, 1);
  renderCalendar();
});
calNext.addEventListener('click', (e) => {
  e.stopPropagation();
  calendarMonthDate = new Date(calendarMonthDate.getFullYear(), calendarMonthDate.getMonth() + 1, 1);
  renderCalendar();
});

// Load slots from server
function loadSlots(date) {
  const dateStr = formatDate(date);
  fetch(`/booking/slots/{{ venue.id }}/?date=${dateStr}`)
    .then(res => res.json())
    .then(data => renderSlots(data))
    .catch(err => {
      console.error('Error loading slots:', err);
      showToast('Gagal memuat jadwal', 'error');
    });
}

// Render slot buttons
function renderSlots(slots) {
  slotContainer.innerHTML = '';
  selectedSlots = [];
  totalPriceEl.textContent = 'Rp0';
  {% if user.is_authenticated %}
    bookButton.disabled = true;
  {% else %}
    bookButton.disabled = true;
  {% endif %}
  bookButton.textContent = '{% if user.is_authenticated %}Book Now{% else %}Login untuk Booking{% endif %}';

  if (slots.length === 0) {
    slotContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">Tidak ada jadwal tersedia untuk tanggal ini</p>';
    return;
  }

  slots.forEach(slot => {
    const div = document.createElement('div');
    
    if (slot.is_booked_by_user) {
      div.className = 'p-3 rounded-lg text-center border-2 border-gray-900 bg-gray-900/10 text-gray-900 cursor-pointer transition hover:bg-gray-900/15';
      div.innerHTML = `
        <div class="text-sm font-semibold">${slot.start_time} - ${slot.end_time}</div>
        <div class="text-xs mt-1">Booked by you</div>
      `;
      div.addEventListener('click', () => toggleSlot(div, slot, true));
    } else if (slot.is_booked) {
      div.className = 'p-3 rounded-lg text-center bg-gray-200 text-gray-500 cursor-not-allowed';
      div.innerHTML = `
        <div class="text-sm font-semibold">${slot.start_time} - ${slot.end_time}</div>
        <div class="text-xs mt-1">Booked</div>
      `;
    } else {
      div.className = 'slot-available p-3 rounded text-center border border-gray-300 bg-white hover:border-gray-900/60 cursor-pointer transition';
      div.innerHTML = `
        <div class="text-sm font-semibold text-[#000456]">${slot.start_time} - ${slot.end_time}</div>
        <div class="text-xs mt-1 text-[#000456] font-medium">Rp${parseInt(slot.price).toLocaleString('id-ID')}</div>
      `;
      div.addEventListener('click', () => toggleSlot(div, slot, false));
    }
    
    div.dataset.id = slot.id;
    div.dataset.price = slot.price;
    slotContainer.appendChild(div);
  });
}

// Toggle slot selection or cancel booking
function toggleSlot(el, slot, isBookedByUser) {
  const id = el.dataset.id;
  
  if (isBookedByUser) {
    // Show custom confirmation modal
    const startTime = slot.start_time.substring(0, 5);
    const endTime = slot.end_time.substring(0, 5);
    confirmMessage.textContent = `Apakah Anda yakin ingin membatalkan booking untuk slot ${startTime} - ${endTime}?`;
    pendingCancelId = id;
    confirmModal.classList.remove('hidden');
  } else {
    // Toggle selection
    if (el.classList.contains('selected')) {
      selectedSlots = selectedSlots.filter(s => s !== id);
      el.classList.remove('selected', 'border-gray-900', 'bg-gray-900/10');
      el.classList.add('border-gray-300', 'bg-white');
    } else {
      selectedSlots.push(id);
      el.classList.add('selected', 'border-gray-900', 'bg-gray-900/10');
      el.classList.remove('border-gray-300', 'bg-white');
    }
    updateTotal();
  }
}

// Modal event listeners
confirmBtn.addEventListener('click', () => {
  if (pendingCancelId) {
    cancelBooking(pendingCancelId);
    confirmModal.classList.add('hidden');
    pendingCancelId = null;
  }
});

cancelBtn.addEventListener('click', () => {
  confirmModal.classList.add('hidden');
  pendingCancelId = null;
});

// Close modal when clicking outside
confirmModal.addEventListener('click', (e) => {
  if (e.target === confirmModal) {
    confirmModal.classList.add('hidden');
    pendingCancelId = null;
  }
});

// Update total price
function updateTotal() {
  const total = Array.from(document.querySelectorAll('.selected'))
                     .reduce((sum, el) => sum + parseInt(el.dataset.price), 0);
  totalPriceEl.textContent = `Rp${total.toLocaleString('id-ID')}`;
  
  {% if user.is_authenticated %}
    bookButton.disabled = selectedSlots.length === 0;
  {% else %}
    bookButton.disabled = true;
  {% endif %}
}

// Create booking
bookButton.addEventListener('click', () => {
  if (selectedSlots.length === 0) return;
  
  {% if not user.is_authenticated %}
    showToast('Silakan login terlebih dahulu untuk booking', 'error');
    setTimeout(() => {
      window.location.href = '/auth/login?next={{ request.path }}';
    }, 1500);
    return;
  {% endif %}
  
  bookButton.disabled = true;
  bookButton.textContent = 'Processing...';
  
  fetch('/booking/create/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ slots: selectedSlots }),
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      showToast('Booking berhasil!', 'success');
      loadSlots(currentDate);
  bookButton.textContent = 'Book Now';
    } else {
      showToast('Gagal melakukan booking.', 'error');
      bookButton.disabled = false;
  bookButton.textContent = 'Book Now';
    }
  })
  .catch(() => {
    showToast('Terjadi kesalahan server.', 'error');
    bookButton.disabled = false;
  bookButton.textContent = 'Book Now';
  });
});

// Cancel booking
function cancelBooking(slotId) {
  fetch('/booking/cancel/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ slot_id: slotId }),
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      showToast('Booking berhasil dibatalkan.', 'success');
      loadSlots(currentDate);
    } else {
      showToast('Gagal membatalkan booking.', 'error');
    }
  })
  .catch(() => showToast('Terjadi kesalahan server.', 'error'));
}

// Toast notification
function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `
    px-6 py-4 rounded-lg shadow-lg text-white text-center animate-fade-in-down
    ${type === 'success' ? 'bg-gray-900' : 'bg-red-600'}
  `;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-10px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Initialize on page load
initializeDates();

// Animation styles
document.head.insertAdjacentHTML("beforeend", `
<style>
@keyframes fade-in-down {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in-down { 
  animation: fade-in-down 0.3s ease-out; 
  transition: opacity 0.3s, transform 0.3s;
}
</style>
`);
</script>

{% endblock content %}

