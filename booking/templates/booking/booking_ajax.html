{% extends 'base.html' %}
{% load static %}
{% block content %}
{% include 'navbar.html' %}

<div class="bg-gray-100 min-h-screen py-8">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow p-6">
    <h1 class="text-2xl font-bold mb-4">{{ venue.name }}</h1>
    <p class="text-gray-600 mb-6">
      Type: <span class="font-semibold">{{ venue.type|title }}</span><br>
      Lokasi: {{ venue.location }}<br>
      Harga per jam: <span class="text-green-600 font-semibold">Rp{{ venue.price_per_hour }}</span>
    </p>

    <!-- Date picker -->
    <div class="mb-6">
      <label class="block font-medium text-gray-700 mb-2">Pilih Tanggal:</label>
      <input type="date" id="datePicker"
             class="border border-gray-300 rounded-lg px-4 py-2 w-60 focus:ring focus:ring-blue-200 focus:outline-none"
             min="{{ today|date:'Y-m-d' }}" />
    </div>

    <!-- Slot container -->
    <div id="slotContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>

    <!-- Button -->
    <div class="mt-6 flex items-center justify-between">
      <p class="font-semibold text-lg">Total: <span id="totalPrice">Rp0</span></p>
      <button id="bookButton"
              class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
              disabled>Booking Sekarang</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
const datePicker = document.getElementById('datePicker');
const slotContainer = document.getElementById('slotContainer');
const totalPriceEl = document.getElementById('totalPrice');
const bookButton = document.getElementById('bookButton');
let selectedSlots = [];

// Load slot saat tanggal dipilih
datePicker.addEventListener('change', () => {
  fetch(`/booking/slots/{{ venue.id }}/?date=${datePicker.value}`)
    .then(res => res.json())
    .then(data => renderSlots(data));
});

// Render slot
function renderSlots(slots) {
  slotContainer.innerHTML = '';
  selectedSlots = [];
  totalPriceEl.textContent = 'Rp0';
  bookButton.disabled = true;

  slots.forEach(slot => {
    const div = document.createElement('div');
    div.className = `
      p-3 rounded-lg text-center border cursor-pointer transition
      ${slot.is_booked_by_user ? 'bg-blue-100 border-blue-400 text-blue-700'
      : slot.is_booked ? 'bg-gray-200 text-gray-500 cursor-not-allowed'
      : 'bg-green-100 hover:bg-green-200'}
    `;
    div.textContent = `${slot.start_time} - ${slot.end_time}`;
    div.dataset.id = slot.id;
    div.dataset.price = slot.price;

    if (!slot.is_booked || slot.is_booked_by_user) {
      div.addEventListener('click', () => toggleSlot(div, slot.is_booked_by_user));
    }

    slotContainer.appendChild(div);
  });
}

// Toggle select / cancel
function toggleSlot(el, isBookedByUser = false) {
  const id = el.dataset.id;
  const price = parseInt(el.dataset.price);

  if (isBookedByUser) {
    // Cancel booking
    cancelBooking(id);
  } else {
    if (selectedSlots.includes(id)) {
      selectedSlots = selectedSlots.filter(s => s !== id);
      el.classList.remove('bg-green-300');
      el.classList.add('bg-green-100');
    } else {
      selectedSlots.push(id);
      el.classList.remove('bg-green-100');
      el.classList.add('bg-green-300');
    }
    updateTotal();
  }
}

// Update total
function updateTotal() {
  const total = Array.from(document.querySelectorAll('.bg-green-300'))
                     .reduce((sum, el) => sum + parseInt(el.dataset.price), 0);
  totalPriceEl.textContent = `Rp${total.toLocaleString()}`;
  bookButton.disabled = selectedSlots.length === 0;
}

// Booking AJAX
bookButton.addEventListener('click', () => {
  fetch('/booking/create/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ slots: selectedSlots }),
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      showToast('Booking berhasil!', 'success');
      datePicker.dispatchEvent(new Event('change'));
    } else {
      showToast('Gagal melakukan booking.', 'error');
    }
  })
  .catch(() => showToast('Terjadi kesalahan server.', 'error'));
});

// Cancel booking AJAX
function cancelBooking(slotId) {
  fetch('/booking/cancel/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ slot_id: slotId }),
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      showToast('Booking dibatalkan.', 'error');
      datePicker.dispatchEvent(new Event('change'));
    } else {
      showToast('Gagal membatalkan booking.', 'error');
    }
  })
  .catch(() => showToast('Terjadi kesalahan server.', 'error'));
}

// Toast
function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `
    px-4 py-3 rounded-lg shadow-lg text-white animate-fade-in-down
    ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}
  `;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('opacity-0', 'translate-y-2');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Animasi fade
document.head.insertAdjacentHTML("beforeend", `
<style>
@keyframes fade-in-down {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in-down { animation: fade-in-down 0.3s ease-out; }
</style>
`);
</script>

{% endblock content %}
